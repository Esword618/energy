<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>bind-event</title>
    <style>
        button {
            margin: 5px;
        }
    </style>
    <script type="application/javascript">


        let testObjectDefine = {object: {}};
        (function () {
            const obj = {
                name: "_island",
                age: 18,
                subobj: {
                    objName: "sssss",
                    fff: 123
                },
                cccc: ["aaa", "fff", 123],
            };

            const objProxy = new Proxy(obj, {
                // 获取值时的捕获器
                get: function (target, key) {
                    console.log(`监听到了${key}被获取值`);
                    return target[key];
                },
                // 设置值时的捕获器
                set: function (target, key, newValue) {
                    console.log(`监听到了${key}被设置值`);
                    target[key] = newValue;
                }
            });

            // console.log(objProxy.subobj.objName);
            // objProxy.subobj.objName = "杨杨杨"
            // console.log(objProxy.subobj.objName);
            // console.log(objProxy.cccc[0]);


            Object.defineProperties(testObjectDefine, {
                key1: {
                    id: 333333,
                    get() {
                        msg('key1 get', this.id);
                        return 'key1Value';
                    },
                    set(v) {
                        msg('key1 set', v);
                    }
                },
                key2: {
                    id: 111111,
                    get() {
                        msg('key2 get', this.id);
                        return 'key2Value';
                    },
                    set(v) {
                        msg('key2 set', v);
                    }
                },
                key3: {
                    id: 2222222,
                    get() {
                        msg('key3 get', this.id);
                        return function () {
                            msg('function')
                            return "函数返回值"
                        };
                    },
                    set(v) {
                        msg('key3 set', v);
                    }
                }
            });
            Object.defineProperty(testObjectDefine.object, "myparam", {
                get() {
                    msg('get myparam');
                    return 'myparamValue';
                },
                set(v) {
                    msg('set myparam');
                }
            });
        })();
        const testObject = {
            "nullKey": {"t": 15, "p": 824635236688},
            "funcKey": {"p": 824635236832, "t": 18},
            "object": {
                "p": 824635236976,
                "Key2": {"t": 0, "p": 824635237168},
                "Key4": {"p": 824635237360, "t": 13},
                "Key5": {"p": 824635237456, "t": 14},
                "Key6": {
                    "Key1": {"p": 824635237648, "t": 0},
                    "Key2": {"p": 824635237744, "t": 0},
                    "p": 824635237552,
                    "t": 20
                },
                "Key7": {
                    "t": 20,
                    "Key1": {"p": 824635237936, "t": 0},
                    "Key2": {"p": 824635238032, "t": 0},
                    "Key3": {"p": 824635238128, "t": 1},
                    "Key4": {
                        "p": 824635238224,
                        "t": 20,
                        "Key1": {"p": 824635238320, "t": 0},
                        "Key2": {"p": 824635238416, "t": 0}
                    },
                    "Key5": {"t": 17, "p": 824635238464},
                    "p": 824635237840
                },
                "Key8": {"p": 824635238512, "t": 17},
                "Key9": {"p": 824635238560, "t": 17},
                "t": 20,
                "Key1": {"t": 0, "p": 824635237072},
                "Key3": {"p": 824635237264, "t": 1},
                "Key10": {
                    "Key1": {"p": 824635238752, "t": 0},
                    "Key2": {"p": 824635238848, "t": 0},
                    "Key3": {"p": 824635238944, "t": 1},
                    "Key4": {"p": 824635239040, "t": 15},
                    "Key5": {"p": 824635239088, "t": 17},
                    "p": 824635238656,
                    "t": 20
                }
            },
            "arrayKey": [{"p": 824635239232, "t": 0}, {"p": 824635239328, "t": 1}, {
                "p": 824635239424,
                "t": 13
            }, {"p": 824635239520, "t": 14}, {"p": 824635239616, "t": 20}],
            "stringKey": {"p": 824635178544, "t": 0},
            "integerKey": {"p": 824635178832, "t": 1},
            "doubleKey": {"p": 824635236400, "t": 13},
            "booleanKey": {"p": 824635236592, "t": 14},
            "undefinedKey": {"p": 824635236784, "t": 15}
        }
        const __energy = {
            util: {
                isObject: function (value) {
                    return value.t === 20
                },
                isArray: function (value) {
                    return Array.isArray(value);
                },
                isFunction: function (value) {
                    return value.t === 18
                }
            },
            consts: {
                isProxyKey: "isProxyKey",
            }
        }
        //
        const handler = {
            get(target, key, receiver) {
                let ret = target[key]
                console.log("ret key:", key, "p:", ret.p)
                if (__energy.util.isObject(ret)) {
                    console.log("\tget object:", ret);
                    if (!ret[__energy.consts.isProxyKey]) {
                        ret = addSubProxy(ret)
                        ret[__energy.consts.isProxyKey] = true
                    }
                } else if (__energy.util.isFunction(ret)) {
                    console.log("\tget func:", ret);
                    return function () {
                        console.log("\tcall func:", arguments);
                    }
                } else if (__energy.util.isArray(ret)) {
                    console.log("\tget array:", ret);
                    ret = addSubProxy(ret)
                } else {

                }
                return ret
            },
            set: function (target, key, value, receiver) {
                if (key === __energy.consts.isProxyKey) {
                    target[key] = value
                    return true
                }
                console.log(`set ${key}`, target[key], value);
                return true
            },
            deleteProperty: function (target, key) {
                console.log(`deleteProperty: ${key}`, target[key]);
                throw new Error(`绑定对象不允许删除 ${target} - "${key}" `);
                return false
            },
            isExtensible: function (target) {
                console.log(`isExtensible:`, target);
                return false
            }
        }

        function createProxy(obj) {
            return addSubProxy(obj)
        }

        function addSubProxy(subObj) {
            return new Proxy(subObj, handler)
        }

        const energya = createProxy(testObject)


        function testDefine() {
            // msg(energya.myparam.ccc)
            //msg(energya.myparam.bbbb())
            //energya.object.Key1 = "3333"
            // energya.funcKey(1, 2, 3, 4)
            console.log(energya.arrayKey[0])
            // console.log(energya.object.Key1)
            // energya.aaaa = "ffff"
            // msg('testFunc:', energya.testFunc(1, 23))
            //delete energya.integerKey
            // console.log( Object.isExtensible(testObject))
            // msg(Object.isExtensible(energya))
            // msg(testObjectDefine.key1)
            // msg(testObjectDefine.key2)
            // msg(testObjectDefine.key3())
            // msg(testObjectDefine.object.myparam)
        }
    </script>
</head>
<body style="margin: 0px;padding: 0px;">
<p>
<h3 style="-webkit-app-region: drag;">bind</h3></p>
<p><a target="_blank" href="bind-event.html">open</a></p>
<p>
    自动执行时间/毫秒: <input id="time" value="0">
    <br>
    <button onclick="testDefine()">testDefine</button>

</p>
<p id="msgHtml"></p>
</body>
<script type="application/javascript">
    let msgHtml = document.getElementById("msgHtml");

    function msg(...vvv) {
        let str = msgHtml.innerHTML;
        for (let i = 0; i < vvv.length; i++) {
            str = str + "  " + vvv[i];
        }
        str += "<br>";
        msgHtml.innerHTML = str;
    }

    function clearMsg() {
        msgHtml.innerHTML = "";
    }

    msg("ipc-event: 页面加载完成...");
</script>
</html>